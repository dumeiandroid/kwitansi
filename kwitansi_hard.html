<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kwitansi Resmi - PT Lidan Indah Abadi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Times+New+Roman&display=swap');
        body { background-color: #f3f4f6; font-family: 'Times New Roman', Times, serif; }
        
        .paper {
            width: 210mm;
            height: 148.5mm;
            padding: 10mm 15mm; 
            margin: 20px auto;
            background: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .line-header { border-bottom: 3px solid #BF1A54; margin-top: 5px; }
        .line-header-thin { border-bottom: 1px solid #BF1A54; margin-top: 2px; }

        @media print {
            @page { size: A5 landscape; margin: 0; }
            body { background: none; padding: 0; }
            .paper { margin: 0; box-shadow: none; width: 210mm; height: 148.5mm; }
            .no-print { display: none; }
        }

        .kwitansi-box {
            border: 2px solid #BF1A54;
            border-radius: 12px;
            padding: 18px;
            margin-top: 8px;
            flex-grow: 1;
            background-image: url('https://lidan.co.id/gambar/logo-baru.png');
            background-repeat: no-repeat;
            background-position: 40% 50%;
            background-size: 20%;
            background-blend-mode: overlay;
            background-color: rgba(255, 255, 255, 0.98);
        }

        .no-bg-pdf { background-image: none !important; }

        /* Style Tabel Agar Titik Dua Sejajar Sempurna */
        .info-table { width: 100%; border-collapse: collapse; }
        .info-table td { padding: 6px 0; font-size: 11pt; vertical-align: top; border-bottom: 1px dotted #eee; }
        .info-table tr:last-child td { border-bottom: none; }
        
        .label-col { width: 130px; font-weight: bold; color: #374151; }
        .separator-col { width: 15px; text-align: center; font-weight: bold; }
        .content-col { font-weight: normal; }
    </style>
</head>
<body>

    <div class="no-print fixed top-5 right-5 flex gap-2">
        <button onclick="window.print()" class="bg-gray-600 text-white px-6 py-2 rounded-full font-bold shadow-lg">Cetak</button>
        <button onclick="downloadPDF()" class="bg-indigo-600 text-white px-6 py-2 rounded-full font-bold shadow-lg">Simpan PDF</button>
    </div>

    <div class="paper" id="invoice-content">
        <div class="flex items-center gap-4">
            <img src="https://lidan.co.id/gambar/logo-baru.png" alt="Logo Lidan" class="w-16 h-auto">
            <div class="flex-1 text-center">
                <h1 style="color: #BF1A54;" class="text-xl font-bold uppercase tracking-widest">PT Lidan Indah Abadi</h1>
                <p class="text-[8pt]">Jl. Imam Bonjol No. 9, Regus Forum Nine Lt.9, Medan, Sumatera Utara</p>
            </div>
        </div>
        
        <div class="line-header"></div>
        <div class="line-header-thin"></div>

        <div id="loading" class="text-center py-10 text-gray-400">Menyusun Kwitansi...</div>

        <div id="kwitansi-isi" class="hidden">
            <div class="flex justify-between items-end mt-2 px-1">
                <h2 class="text-2xl font-black uppercase tracking-tighter" style="color: #BF1A54;">KWITANSI</h2>
                <p id="nomor-kwitansi" class="text-[10pt] font-mono text-gray-700 font-bold border-b border-gray-200"></p>
            </div>

            <div id="main-box" class="kwitansi-box">
                <div class="grid grid-cols-12 gap-4 h-full">
                    <div class="col-span-8 border-r border-gray-100 pr-4">
                        <table class="info-table">
                            <tr>
                                <td class="label-col">Telah Terima Dari</td>
                                <td class="separator-col">:</td>
                                <td class="content-col font-black uppercase text-gray-800"><span id="pihak-dari"></span></td>
                            </tr>
                            <tr>
                                <td class="label-col">Uang Sejumlah</td>
                                <td class="separator-col">:</td>
                                <td class="content-col font-black text-xl" style="color: #BF1A54;"><span id="nominal-angka"></span></td>
                            </tr>
                            <tr>
                                <td class="label-col">Terbilang</td>
                                <td class="separator-col">:</td>
                                <td class="content-col italic text-[10pt] bg-gray-50 px-2 rounded"><span id="terbilang"></span></td>
                            </tr>
                            <tr>
                                <td class="label-col">Untuk Pembayaran</td>
                                <td class="separator-col">:</td>
                                <td class="content-col font-medium text-[11pt]"><span id="keperluan"></span></td>
                            </tr>
                        </table>
                    </div>

                    <div class="col-span-4 flex flex-col justify-between items-center text-center">
                        <div>
                            <p class="text-[9pt]">Medan, <span id="tanggal-ttd"></span></p>
                            <p class="font-bold text-[10pt] mt-1">PT Lidan Indah Abadi</p>
                            <p class="text-[8pt] text-gray-500 mb-8">Penerima,</p>
                            <p class="font-bold underline uppercase text-[10pt]">Finance Department</p>
                            <p class="text-[8pt] italic text-gray-600">Authorized Signature</p>
                        </div>
                        <div id="qrcode" class="p-1 border border-gray-200 rounded bg-white w-[75px] h-[75px]"></div>
                    </div>
                </div>
            </div>
            <div class="mt-2 text-[7pt] text-gray-400 italic">Dokumen ini sah secara elektronik. Verifikasi: sign.lidan.co.id</div>
        </div>
    </div>

    <script>
        const API_URL = 'https://lidan-co-id.pages.dev/api/contacts_filter_dinamis6';
        const TABLE_TARGET = 'kwitansi';
        const AUTH_KEY = 'admin';
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');

        let metaPDF = { name: "customer", no: "100" };

        async function fetchKwitansi() {
            if(!token) return;
            try {
                const res = await fetch(`${API_URL}?table=${TABLE_TARGET}&x_10_eq=${token}`, {
                    headers: { 'X-Custom-Auth': AUTH_KEY }
                });
                const result = await res.json();
                
                if(result.success && result.data.length > 0) {
                    const item = result.data[0];
                    // Logika penjumlahan ID + 100
                    let rawId = item.id_x || item.id || item.x_00 || "0";
                    let numericId = parseInt(rawId.toString().replace(/\D/g, '')) || 0;
                    let finalNumber = numericId + 100;
                    
                    renderKwitansi(item, finalNumber);
                }
            } catch (e) { console.error(e); }
        }

        function renderKwitansi(data, nomorFix) {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('kwitansi-isi').classList.remove('hidden');

            metaPDF.no = nomorFix;
            metaPDF.name = (data.x_02 || "penerima").toLowerCase().replace(/\s+/g, '_');

            document.getElementById('nomor-kwitansi').innerText = `NO: ${nomorFix}/KW/LIDAN/2026`;
            document.getElementById('tanggal-ttd').innerText = data.x_06 || '';
            document.getElementById('pihak-dari').innerText = data.x_02 || '-';
            
            const nominal = parseInt(data.x_04) || 0;
            document.getElementById('nominal-angka').innerText = 'Rp ' + nominal.toLocaleString('id-ID');
            document.getElementById('terbilang').innerText = terbilang(nominal) + ' Rupiah';
            document.getElementById('keperluan').innerText = data.x_03 || '-';

            new QRCode(document.getElementById("qrcode"), {
                text: `https://sign.lidan.co.id/kwitansi?token=${data.x_10}`,
                width: 75, height: 75
            });
        }

        function terbilang(angka) {
            const bilangan = ['', 'Satu', 'Dua', 'Tiga', 'Empat', 'Lima', 'Enam', 'Tujuh', 'Delapan', 'Sembilan', 'Sepuluh', 'Sebelas'];
            if (angka < 12) return bilangan[angka];
            if (angka < 20) return terbilang(angka - 10) + ' Belas';
            if (angka < 100) return terbilang(Math.floor(angka / 10)) + ' Puluh ' + terbilang(angka % 10);
            if (angka < 200) return 'Seratus ' + terbilang(angka - 100);
            if (angka < 1000) return terbilang(Math.floor(angka / 100)) + ' Ratus ' + terbilang(angka % 100);
            if (angka < 2000) return 'Seribu ' + terbilang(angka - 1000);
            if (angka < 1000000) return terbilang(Math.floor(angka / 1000)) + ' Ribu ' + terbilang(angka % 1000);
            if (angka < 1000000000) return terbilang(Math.floor(angka / 1000000)) + ' Juta ' + terbilang(angka % 1000000);
            return angka.toString();
        }

        function downloadPDF() {
            const element = document.getElementById('invoice-content');
            const box = document.getElementById('main-box');
            box.classList.add('no-bg-pdf');
            
            const opt = {
                margin: 0,
                filename: `kwitansi_${metaPDF.name}_${metaPDF.no}.pdf`,
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { scale: 4, useCORS: true },
                jsPDF: { unit: 'mm', format: 'a5', orientation: 'landscape' }
            };

            html2pdf().set(opt).from(element).save().then(() => {
                box.classList.remove('no-bg-pdf');
            });
        }

        fetchKwitansi();
    </script>
</body>
</html>