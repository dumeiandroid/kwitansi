<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Kwitansi Lidan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        .loader { border-top-color: #4f46e5; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen font-sans">

    <script>
        // --- KONFIGURASI ---
        const APP_CONFIG = {
            "api": {
                "baseUrl": "https://lidan-co-id.pages.dev/api/contacts_filter_dinamis6",
                "authKey": "admin",
                "tableName": "kwitansi"
            },
            "urls": {
                "detailBase": "https://kwitansi.lidan.co.id/kwitansi",
                "printBase": "https://kwitansi.lidan.co.id/kwitansi_hard"
            }
        };

        // Fungsi Helper: Ambil ID Angka Terbesar dari Database
        function getMaxId(dataArray) {
            if (!dataArray || dataArray.length === 0) return 0;
            return Math.max(...dataArray.map(item => {
                // Mencari ID di properti 'id' atau 'id_x'
                const val = item.id || item.id_x || 0;
                return parseInt(val) || 0;
            }));
        }

        // Fungsi Helper: Format Nomor (Angka+100/Bulan/K/LIDAN/Tahun)
        function formatFullNumber(numericID) {
            const date = new Date();
            const month = date.getMonth() + 1;
            const year = date.getFullYear();
            return `${parseInt(numericID) + 100}/${month}/K/LIDAN/${year}`;
        }
    </script>

    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="https://lidan.co.id/gambar/logo-baru.png" class="h-10">
                <h1 class="font-bold text-gray-800 text-lg uppercase tracking-tight">Kwitansi Admin</h1>
            </div>
            <button onclick="loadData()" class="text-sm font-bold text-indigo-600 hover:bg-indigo-50 px-4 py-2 rounded-lg transition">Refresh Data</button>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 py-8">
        <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 mb-8 flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h2 class="text-2xl font-black text-gray-900">Database Kwitansi</h2>
                <p class="text-sm text-gray-500">Domain Aktif: kwitansi.lidan.co.id</p>
            </div>
            <button onclick="openCreateModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold px-6 py-3 rounded-xl shadow-lg transition">
                + Buat Kwitansi Baru
            </button>
        </div>

        <div id="main-loader" class="flex justify-center py-20"><div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div></div>
        
        <div id="table-container" class="hidden overflow-x-auto bg-white rounded-2xl shadow-sm border border-gray-100">
            <table class="w-full text-left">
                <thead class="bg-gray-50 border-b border-gray-100">
                    <tr>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">Nomor</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">Diterima Dari</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400">Nominal</th>
                        <th class="px-6 py-4 text-[10px] font-black uppercase text-gray-400 text-center">Aksi</th>
                    </tr>
                </thead>
                <tbody id="table-body" class="divide-y divide-gray-50"></tbody>
            </table>
        </div>
    </main>

    <div id="modal-form" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-3xl shadow-2xl overflow-hidden">
            <div class="bg-indigo-900 p-6 text-white flex justify-between items-center">
                <h3 class="font-bold text-lg" id="modal-title">Form Kwitansi</h3>
                <button onclick="closeModal()" class="text-2xl leading-none">&times;</button>
            </div>
            <form id="kwitansi-form" class="p-8 space-y-4">
                <input type="hidden" id="edit_id" name="id">
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 block mb-1">Nomor Kwitansi (Otomatis)</label>
                    <input type="text" id="x_05" name="x_05" readonly class="w-full bg-gray-50 border-gray-200 rounded-xl px-4 py-3 text-indigo-700 font-mono font-bold">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-[10px] font-black uppercase text-gray-400 block mb-1">Tanggal Bayar</label>
                        <input type="text" id="x_06" name="x_06" required class="w-full border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-gray-400 block mb-1">Nominal (Rp)</label>
                        <input type="number" id="x_04" name="x_04" required class="w-full border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500">
                    </div>
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 block mb-1">Diterima Dari</label>
                    <input type="text" id="x_02" name="x_02" required class="w-full border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="text-[10px] font-black uppercase text-gray-400 block mb-1">Untuk Pembayaran</label>
                    <textarea id="x_03" name="x_03" rows="2" required class="w-full border-gray-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-indigo-500"></textarea>
                </div>
                
                <input type="hidden" name="x_01" value="PENERIMAAN">
                <input type="hidden" id="x_10" name="x_10"> <div class="flex gap-2 pt-4">
                    <button type="button" onclick="closeModal()" class="flex-1 bg-gray-100 text-gray-500 font-bold py-4 rounded-2xl">Batal</button>
                    <button type="submit" id="btn-submit" class="flex-[2] bg-indigo-600 text-white font-bold py-4 rounded-2xl shadow-lg hover:bg-indigo-700 transition">Simpan Kwitansi</button>
                </div>
            </form>
        </div>
    </div>

    <div id="modal-qr" class="fixed inset-0 bg-black/80 z-50 hidden flex items-center justify-center p-4">
        <div id="qr-capture-area" class="bg-white p-10 rounded-[3rem] text-center max-w-sm w-full">
            <div id="qrcode-preview" class="flex justify-center mb-6 p-4 bg-white border-2 border-dashed border-indigo-100 rounded-3xl"></div>
            <h4 id="qr-token-label" class="font-mono text-xs font-bold text-indigo-500 mb-6 break-all"></h4>
            <div class="flex flex-col gap-2">
                <button onclick="downloadQR()" class="bg-indigo-600 text-white font-bold py-3 rounded-xl shadow-lg">Simpan Gambar QR</button>
                <button onclick="closeQR()" class="text-gray-400 font-bold py-2">Tutup</button>
            </div>
        </div>
    </div>

    <script>
        let fullData = [];
        let isEditMode = false;

        async function loadData() {
            showMainLoader(true);
            try {
                const res = await fetch(`${APP_CONFIG.api.baseUrl}?table=${APP_CONFIG.api.tableName}`, {
                    headers: { 'X-Custom-Auth': APP_CONFIG.api.authKey }
                });
                const result = await res.json();
                if(result.success) {
                    fullData = result.data;
                    renderTable(fullData);
                }
            } catch (e) { console.error("Load failed:", e); }
            showMainLoader(false);
        }

        function renderTable(data) {
            const body = document.getElementById('table-body');
            body.innerHTML = '';
            // Urutkan ID terbesar di atas
            const sorted = [...data].sort((a,b) => (parseInt(b.id || b.id_x || 0)) - (parseInt(a.id || a.id_x || 0)));
            
            sorted.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition";
                tr.innerHTML = `
                    <td class="px-6 py-4 font-mono text-xs font-bold text-indigo-600">${item.x_05 || '-'}</td>
                    <td class="px-6 py-4 text-sm font-bold text-gray-700 uppercase">${item.x_02 || '-'}</td>
                    <td class="px-6 py-4 text-sm font-black">Rp ${(parseInt(item.x_04)||0).toLocaleString('id-ID')}</td>
                    <td class="px-6 py-4 text-center">
                        <div class="flex justify-center gap-2">
                            <button onclick="openEditModal('${item.x_10}')" class="px-3 py-1 bg-amber-50 text-amber-600 rounded-md text-[10px] font-bold hover:bg-amber-100 transition">EDIT</button>
                            <a href="${APP_CONFIG.urls.printBase}?token=${item.x_10}" target="_blank" class="px-3 py-1 bg-gray-100 text-gray-600 rounded-md text-[10px] font-bold hover:bg-gray-200">CETAK</a>
                            <button onclick="openQR('${item.x_10}')" class="px-3 py-1 bg-indigo-50 text-indigo-600 rounded-md text-[10px] font-bold hover:bg-indigo-100">QR</button>
                            <button onclick="deleteData('${item.x_10}')" class="px-3 py-1 bg-red-50 text-red-500 rounded-md text-[10px] font-bold hover:bg-red-100">HAPUS</button>
                        </div>
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        // --- SUBMIT DENGAN PERLINDUNGAN DOUBLE NOMOR ---
        document.getElementById('kwitansi-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.disabled = true;
            btn.innerText = "Memverifikasi...";

            let finalX05 = document.getElementById('x_05').value;

            // Jika tambah baru, cek ID terbaru di server agar tidak tabrakan
            if(!isEditMode) {
                try {
                    const checkRes = await fetch(`${APP_CONFIG.api.baseUrl}?table=${APP_CONFIG.api.tableName}`, {
                        headers: { 'X-Custom-Auth': APP_CONFIG.api.authKey }
                    });
                    const checkResult = await checkRes.json();
                    const currentMax = getMaxId(checkResult.data);
                    
                    // Gunakan ID terbesar + 1
                    finalX05 = formatFullNumber(currentMax + 1);
                } catch (err) { console.error("Double check failed", err); }
            }

            const formData = new FormData(e.target);
            const dataObj = Object.fromEntries(formData.entries());
            dataObj.x_05 = finalX05; 

            try {
                const method = isEditMode ? 'PATCH' : 'POST';
                const currentId = dataObj.id || document.getElementById('edit_id').value;
                const url = isEditMode ? 
                    `${APP_CONFIG.api.baseUrl}?table=${APP_CONFIG.api.tableName}&id_eq=${currentId}` : 
                    `${APP_CONFIG.api.baseUrl}?table=${APP_CONFIG.api.tableName}`;
                
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'X-Custom-Auth': APP_CONFIG.api.authKey },
                    body: JSON.stringify(dataObj)
                });
                
                const resJson = await res.json();
                if(resJson.success) {
                    closeModal();
                    loadData();
                } else {
                    alert("Error: " + resJson.message);
                }
            } catch (e) { alert("Masalah koneksi database"); }
            
            btn.disabled = false;
            btn.innerText = "Simpan Kwitansi";
        };

        function openCreateModal() {
            isEditMode = false;
            document.getElementById('modal-title').innerText = "Buat Kwitansi Baru";
            document.getElementById('kwitansi-form').reset();
            
            // Generate Token
            document.getElementById('x_10').value = 'LIDAN-' + Math.random().toString(36).substr(2, 9).toUpperCase();
            
            // Tanggal Indo
            const d = new Date();
            const months = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
            document.getElementById('x_06').value = `${d.getDate()} ${months[d.getMonth()]} ${d.getFullYear()}`;
            
            // Prediksi nomor berdasarkan data lokal saat ini
            const lastId = getMaxId(fullData);
            document.getElementById('x_05').value = formatFullNumber(lastId + 1);

            document.getElementById('modal-form').classList.remove('hidden');
        }

        function openEditModal(token) {
            isEditMode = true;
            const item = fullData.find(i => i.x_10 === token);
            if(!item) return;

            document.getElementById('modal-title').innerText = "Edit Data Kwitansi";
            document.getElementById('edit_id').value = item.id || item.id_x;
            document.getElementById('x_05').value = item.x_05;
            document.getElementById('x_06').value = item.x_06;
            document.getElementById('x_04').value = item.x_04;
            document.getElementById('x_02').value = item.x_02;
            document.getElementById('x_03').value = item.x_03;
            document.getElementById('x_10').value = item.x_10;

            document.getElementById('modal-form').classList.remove('hidden');
        }

        function openQR(token) {
            document.getElementById('modal-qr').classList.remove('hidden');
            document.getElementById('qrcode-preview').innerHTML = '';
            document.getElementById('qr-token-label').innerText = token;
            new QRCode(document.getElementById("qrcode-preview"), {
                text: `${APP_CONFIG.urls.detailBase}?token=${token}`,
                width: 200, height: 200, colorDark : "#1e1b4b"
            });
        }

        function downloadQR() {
            html2canvas(document.getElementById('qr-capture-area'), { scale: 3 }).then(canvas => {
                const link = document.createElement('a');
                link.download = `QR_${document.getElementById('qr-token-label').innerText}.png`;
                link.href = canvas.toDataURL(); link.click();
            });
        }

        async function deleteData(token) {
            if(!confirm("Hapus kwitansi ini?")) return;
            try {
                await fetch(`${APP_CONFIG.api.baseUrl}?table=${APP_CONFIG.api.tableName}&x_10_eq=${token}`, {
                    method: 'DELETE', headers: { 'X-Custom-Auth': APP_CONFIG.api.authKey }
                });
                loadData();
            } catch (e) { alert("Gagal menghapus"); }
        }

        function closeModal() { document.getElementById('modal-form').classList.add('hidden'); }
        function closeQR() { document.getElementById('modal-qr').classList.add('hidden'); }
        function showMainLoader(s) { 
            document.getElementById('main-loader').style.display = s ? 'flex' : 'none'; 
            document.getElementById('table-container').classList.toggle('hidden', s);
        }

        // Jalankan saat startup
        loadData();
    </script>
</body>
</html>